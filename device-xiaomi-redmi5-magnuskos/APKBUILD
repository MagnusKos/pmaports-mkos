# Reference: <https://postmarketos.org/devicepkg>
# Based on device-qcom-msm8953

pkgname=device-xiaomi-redmi5-magnuskos
pkgdesc="Custom device package for Xiaomi Redmi 5 by MagnusKos."
pkgver=0.5
pkgrel=0

url="https://magnuskos.ru"
license="MIT"
arch="aarch64"
options="!check !archcheck"

subpackages="$pkgname-systemd"

depends="
    linux-magnuskos-qcom-msm8953
    firmware-qcom-msm8953
    firmware-qcom-adreno-a530
	lk2nd-msm8953
	mkbootimg
	msm-firmware-loader
	postmarketos-base
	qbootctl
	soc-qcom-msm8953
	soc-qcom-msm8953-modem
	linux-firmware-mediatek
	linux-firmware-ath9k_htc
"

replaces="
	openssh-server-common
"

install="
		$pkgname-systemd.post-install
		$pkgname-systemd.post-upgrade
"

makedepends="devicepkg-dev"

source="deviceinfo
        modules-initfs
        sshd_config
        mkinitfs_firmware
        99-usb-net-gate.sh"

build() {
    devicepkg_build $startdir $pkgname
}

package() {
    devicepkg_package $startdir $pkgname

    install -Dm644 "$srcdir"/sshd_config \
		"$pkgdir"/etc/ssh/sshd_config

	install -Dm644 "$srcdir"/mkinitfs_firmware \
		"$pkgdir"/etc/mkinitfs/files/firmware

	install -Dm755 "$srcdir"/99-usb-net-gate.sh \
		"$pkgdir"/usr/lib/NetworkManager/dispatcher.d/99-usb-net-gate.sh
}

systemd() {
	default_systemd

	mkdir -p "$subpkgdir"
}

sha512sums="
574a3612e9fbddf43ccab9570d3a236bbca92d4408a1b493074547460305ebb485b9b5f46543f4a51efc486b8e8df28021b711f0bb78f4554f26a9fdccd59eba  deviceinfo
83d3a9519a659607b492b5a5a676eb46d589855b68751dfbad02f9d9dcdf84652c3a22f89357e2068b622ea91398f1590e7f26293330eb72558b9b55705fa434  modules-initfs
e0445222f6c8aeaf5ed9a88f8975bb6d0f1bed23a88b2dea3bf05a22ad9475e69698fbd549a60a575f9770441a009fe5e581166cdeea30b4c876043e83611054  sshd_config
9b87e2713b20f607fa5927f55ef9fa6fa4d2d6909d19ad01f3035adacd4678ef42551613eea165b16362ec6b5171881185910e9f05914abd5460f45277e53250  mkinitfs_firmware
53687908cb244ae61df6dccdeb0e066126688c84dee253c0b22242c4adf9f22d7d2dfabeb754b1cb7084551e0d89705e07f2d787ef710e27dc122a681515daf6  99-usb-net-gate.sh
"
